# 🎯 動態兩階段止盈止損策略 v10.9.2

## 📌 問題背景

歷史交易數據顯示：
- **勝率**: 33勝 / 21負 = **61% 勝率**
- **獲勝平均**: +3.76%
- **虧損平均**: -9.59%
- **問題**: 虧損是獲利的 **2.55 倍**，導致整體虧損 77%

> 💡 核心問題：勝率夠高但風險報酬比太差，需要嚴格控制虧損

---

## 🏗️ 策略架構

### 兩階段設計

```
┌─────────────────────────────────────────────────────────────────┐
│                    交易生命週期                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  進場 ──▶ 【第一階段】費用突破期 ──▶ 【第二階段】鎖利期 ──▶ 出場  │
│              (淨利 < 4%)              (淨利 ≥ 4%)                 │
│                                                                 │
│  目標：突破手續費門檻              目標：追蹤止盈，鎖住利潤        │
│  特點：嚴格止損，快進快出          特點：動態追蹤，保護利潤        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 第一階段：費用突破期 (Phase 1)

### 目標
突破 **4% 手續費門檻**（100X 槓桿下，開平倉各 0.02% Maker = 約 4% 實際成本）

### 動態參數

| 市場品質 | 止盈目標 | 基礎止損 | 時間限制 |
|---------|---------|---------|---------|
| 🟢 GOOD (≥65分) | 歷史平均 × 1.3 ≈ **4.9%** | 止盈 × 1.0 ≈ **4.9%** | 5 分鐘 |
| 🟡 NORMAL (35-65分) | 歷史平均 × 1.0 ≈ **3.8%** | 止盈 × 0.9 ≈ **3.4%** | 4 分鐘 |
| 🔴 BAD (<35分) | 歷史平均 × 0.85 ≈ **3.2%** | 止盈 × 0.75 ≈ **2.4%** | 3 分鐘 |

### 階段性止損調整

根據淨利進度動態收緊止損：

```
淨利 0%~1%  → 止損 = 基礎止損 (給予空間)
淨利 1%~2%  → 止損 = 基礎止損 × 0.75 (稍微收緊)
淨利 2%~3%  → 止損 = 基礎止損 × 0.5 (更緊)
淨利 3%+    → 止損 = 淨利 - 1% (保本模式)
```

### 出場條件

| 條件 | 觸發 | 說明 |
|-----|------|-----|
| 🚨 嚴格止損 | `淨利 ≤ -止損%` | 立即退出，控制虧損 |
| ⚡ 目標達成 | `淨利 ≥ 目標%` | 達到動態目標，獲利了結 |
| ⏰ 時間止損 | `持倉 ≥ N分鐘 且 淨利 < 門檻` | 長時間無進展，止損離場 |

---

## 🔒 第二階段：鎖利期 (Phase 2)

### 進入條件
淨利 ≥ **4%**（已突破費用門檻）

### 追蹤止盈機制

```
追蹤止盈位置 = max(0, 最大淨利 - 追蹤偏移量)

確保：追蹤止盈 ≥ 費用門檻 - 1% (至少保住 3% 利潤)
```

### 動態追蹤偏移量

| 市場品質 | 追蹤偏移 | 最大目標 | 說明 |
|---------|---------|---------|-----|
| 🟢 GOOD | **2.0%** | **6%+** | 條件好，給更多空間跑 |
| 🟡 NORMAL | **1.5%** | **5.5%** | 標準追蹤 |
| 🔴 BAD | **1.0%** | **5%** | 條件差，快速鎖利 |

### 出場條件

| 條件 | 觸發 | 說明 |
|-----|------|-----|
| 🔒 追蹤止盈 | `淨利 ≤ 追蹤止盈位置` | 回撤超過容許範圍，鎖住利潤 |
| 🎯 最大目標 | `淨利 ≥ 最大目標%` | 達到最大目標，全部獲利了結 |

---

## 📈 市場品質評估

每秒動態計算市場品質分數 (0-100)：

### 評分因素

| 因素 | 好條件 | 差條件 |
|-----|--------|--------|
| **波動率** | < 0.3 → +15分 | > 0.8 → -15分 |
| **OBI 強度** | > 0.5 → +20分 | < 0.2 → -10分 |
| **動量一致性** | 1m/5m 同向且 > 0.3% → +15分 | 1m/5m 反向 → -10分 |

### 品質等級

```
🟢 GOOD   : 分數 ≥ 65  → 放寬止損、提高目標
🟡 NORMAL : 35 ≤ 分數 < 65 → 標準參數
🔴 BAD    : 分數 < 35  → 收緊止損、降低目標
```

---

## 🔄 核心設計原則

### 1. 止盈以歷史平均為基礎

```python
base_target = historical_avg_win  # ≈ 3.76%

# 不是固定值，而是根據實際表現動態調整
if is_win:
    historical_avg_win = 滾動平均(最近50筆獲利)
```

### 2. 止損從止盈計算

```python
# 確保風險報酬比 (R:R) 合理
止損 = 止盈目標 × 風險係數

# 風險係數根據市場條件調整
GOOD:   risk_ratio = 1.0   → R:R = 1:1
NORMAL: risk_ratio = 0.9   → R:R = 1:1.11  
BAD:    risk_ratio = 0.75  → R:R = 1:1.33
```

### 3. 每秒動態調整

- 市場品質每秒更新
- 止盈止損參數隨市場條件即時變化
- 階段性止損根據淨利進度收緊

---

## 📊 策略流程圖

```
                         ┌──────────────┐
                         │   進場       │
                         └──────┬───────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ 更新市場品質 (每秒)     │
                    │ 計算動態參數            │
                    └───────────┬───────────┘
                                │
                    ┌───────────▼───────────┐
                    │   淨利 < 4% ?         │
                    └───────────┬───────────┘
                          │           │
                         是          否
                          │           │
                          ▼           ▼
              ┌─────────────────┐  ┌─────────────────┐
              │ 【第一階段】     │  │ 【第二階段】     │
              │  費用突破期      │  │  鎖利期         │
              └────────┬────────┘  └────────┬────────┘
                       │                    │
           ┌───────────┼───────────┐       │
           │           │           │       │
           ▼           ▼           ▼       ▼
      ┌────────┐ ┌────────┐ ┌────────┐ ┌────────────┐
      │嚴格止損│ │目標達成│ │時間止損│ │追蹤止盈    │
      │-SL%   │ │+TP%   │ │N分鐘  │ │最高-偏移  │
      └────┬───┘ └────┬───┘ └────┬───┘ └─────┬──────┘
           │         │         │           │
           └─────────┴─────────┴───────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │    出場       │
                    │ 記錄結果      │
                    │ 更新統計      │
                    └───────────────┘
```

---

## 📋 實際例子

### 例子 1：市場條件好 (GOOD)

```
進場價: $100,000
市場品質: 🟢 GOOD (72分)
歷史平均獲利: 3.76%

動態參數計算:
- 止盈目標 = 3.76% × 1.3 = 4.9%
- 基礎止損 = 4.9% × 1.0 = 4.9%
- 追蹤偏移 = 2.0%

交易過程:
00:00 - 進場，淨利 0%，止損 -4.9%
00:30 - 淨利 +1.5%，止損收緊到 -3.7%
01:00 - 淨利 +2.5%，止損收緊到 -2.5%
01:30 - 淨利 +3.5%，止損改為保本 +2.5%
02:00 - 淨利突破 +4%，進入第二階段
02:30 - 淨利 +5.2% (最高)，追蹤止盈設在 +3.2%
03:00 - 淨利回落到 +4.8%
03:30 - 淨利 +4.9%，達到目標 → 出場 ✅

結果: +4.9% 獲利
```

### 例子 2：市場條件差 (BAD)

```
進場價: $100,000
市場品質: 🔴 BAD (28分)
歷史平均獲利: 3.76%

動態參數計算:
- 止盈目標 = 3.76% × 0.85 = 3.2%
- 基礎止損 = 3.2% × 0.75 = 2.4%
- 時間限制 = 3 分鐘

交易過程:
00:00 - 進場，淨利 0%，止損 -2.4%
01:00 - 淨利 -0.5%，止損維持 -2.4%
02:00 - 淨利 +0.3%，止損維持 -2.4%
03:00 - 持倉已 3 分鐘，淨利僅 +0.3% < +2%
      → 觸發時間止損 → 出場 ⏰

結果: +0.3% 小賺出場 (避免更大虧損)
```

---

## 📁 相關檔案

- **主程式**: `scripts/whale_testnet_trader.py`
- **類別**: `TwoPhaseExitManager`
- **統計儲存**: `logs/two_phase_exit_stats.json`

---

## 🔧 配置參數

```python
# config/config.json
{
    "two_phase_exit_enabled": true,
    "phase1_fee_threshold_pct": 4.0,      # 費用門檻
    "phase1_strict_stop_loss_pct": 4.0,   # 基礎止損
    "phase1_target_pct": 4.0,             # 基礎止盈目標
    "phase2_trailing_start_pct": 4.0,     # 第二階段起始
    "phase2_trailing_offset_pct": 1.5,    # 追蹤偏移
    "phase2_max_target_pct": 6.0,         # 最大目標
    "historical_avg_win_pct": 3.76,       # 歷史平均獲利
    "historical_avg_loss_pct": 9.59       # 歷史平均虧損
}
```

---

## 📝 版本歷史

| 版本 | 日期 | 變更 |
|-----|------|------|
| v10.9.0 | 2025-11-28 | 初版兩階段止盈止損系統 |
| v10.9.1 | 2025-12-05 | 加入動態市場條件調整 |
| v10.9.2 | 2025-12-05 | 止盈以歷史平均為基礎、止損從止盈計算、階段性止損調整 |

---

*最後更新: 2025-12-05*
