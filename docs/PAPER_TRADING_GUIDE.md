# 📝 紙面交易系統使用指南

> **重要性：⭐⭐⭐⭐⭐**  
> 用於真實交易前的風控驗證，確保策略有效性

---

## 📖 系統簡介

紙面交易系統使用**真實市場數據**（Binance WebSocket），模擬交易執行，記錄完整訂單簿，用於驗證風控指標是否真的有用。

### 🎯 核心功能

1. **真實市場數據**：連接 Binance WebSocket，獲取實時訂單簿和成交
2. **多風控模式**：同時運行 4 種風控模式進行對比
3. **完整訂單簿記錄**：保存所有決策、指標、盈虧數據
4. **真實費用計算**：包含 Taker Fee (0.05%)、Funding Rate (0.003%/hr)、Slippage (2 bps)
5. **績效對比分析**：事後驗證風控指標有效性

---

## 🚀 快速開始

### 1. 運行紙面交易

```bash
# 執行方式 (使用虛擬環境 Python)
.venv/bin/python scripts/paper_trading_system.py [分鐘數]

# 範例:
.venv/bin/python scripts/paper_trading_system.py 1   # 測試 1 分鐘
.venv/bin/python scripts/paper_trading_system.py 5   # 測試 5 分鐘 (預設)
.venv/bin/python scripts/paper_trading_system.py 30  # 測試 30 分鐘
```

**完整輸出示例：**

系統會先顯示完整的配置說明和市場指標解釋：

```
================================================================================
📝 Task 1.6.1 - Phase C: 紙面交易系統 (Paper Trading System)
================================================================================

────────────────────────────────────────────────────────────────────────────────
� 市場指標說明
────────────────────────────────────────────────────────────────────────────────
📊 OBI (Order Book Imbalance)     訂單簿失衡度 [-1, 1]
   • 正值 = 買盤強勢 | 負值 = 賣盤強勢 | 0 = 平衡
   • 越接近 ±1 代表失衡越嚴重

⚡ OBI Velocity                    OBI 變化率 (速度)
   • 正值 = 買盤增強 | 負值 = 賣盤增強
   • 絕對值越大代表變化越快

📈 Signed Volume                   淨成交量 (買-賣)
   • 正值 = 主動買單多 | 負值 = 主動賣單多
   • 反映短期買賣壓力

☠️  VPIN (Volume-Synchronized PIN)  毒性指標 [0, 1]
   • 0 = 低風險 | 1 = 高風險
   • >0.5 表示知情交易者活躍，需謹慎

💹 Spread                          買賣價差 (bps)
   • 越小 = 流動性越好 | 越大 = 流動性差

🏊 Depth                           訂單簿深度 (BTC)
   • 前5檔買賣單總量，反映市場承接力
────────────────────────────────────────────────────────────────────────────────

────────────────────────────────────────────────────────────────────────────────
🎨 圖示說明
────────────────────────────────────────────────────────────────────────────────
交易方向:  📈 LONG (做多)  |  📉 SHORT (做空)  |  ⚖️  NEUTRAL (中立)
風險等級:  🟢 SAFE (安全)  |  🟡 WARNING (警告)  |  🔴 CRITICAL (嚴重)
持倉狀態:  🏦 空倉  |  📊 持倉中
開倉:      🚀 開倉  |  🔔 平倉
平倉原因:  🎯 TAKE_PROFIT (止盈)  |  🛑 STOP_LOSS (止損)  |  🔄 REVERSE_SIGNAL (反向)
────────────────────────────────────────────────────────────────────────────────

🎯 風控模式對比:
   Mode 0: ❌ 無風控（所有信號都交易）
   Mode 1: 🟡 僅 VPIN 風控
   Mode 2: 🔵 僅流動性風控（Spread/Depth）
   Mode 3: 🟢 完整風控（所有指標）

⏱️  測試配置:
   💹 交易對: BTCUSDT
   ⚡ 決策模式: 動態觸發 (最快5秒 / 最慢15秒)
   🎯 觸發條件:
      • 強烈信號: |OBI| > 0.6
      • 快速變化: |ΔOBI| > 0.3
      • 方向反轉: OBI跨越0軸

💰 資金配置:
   💵 初始本金: 100.0 USDT
   📊 最大槓桿: 10x
   📐 倉位策略: 🐢 保守 30% | 🚶 中等 50% | 🏃 激進 80%

💸 費率設定:
   ✅ Maker 手續費: 0.02%
   💳 Taker 手續費: 0.05%
   💰 資金費率: 0.003%/小時

🎯 風控設定:
   🟢 安全模式: 槓桿 5x | 止損 5% | 止盈 8%
   🟡 警告模式: 槓桿 2x | 止損 8% | 止盈 12%
   🔴 危險模式: 槓桿 1x | 止損 10% | 止盈 15%

================================================================================

⏰ 運行時長: 1 分鐘

🔌 連接 Binance WebSocket...
✅ WebSocket 已連接

� 初始化訂單簿數據...
   ✅ 訂單簿已初始化
   最佳買價: 104,808.80
   最佳賣價: 104,808.90
   當前價格: $104,808.85
   買單量 (20檔): 2.2860 BTC
   賣單量 (20檔): 15.6360 BTC
   初始 OBI: -0.7449

�🔥 開始紙面交易...
```

接著進行決策分析（6 步驟完整顯示）：

```
================================================================================
[15:40:27] 🧠 定期決策分析 #1
================================================================================
   🔍 [1/6] 計算 OBI (訂單簿失衡)... ✅ OBI = -0.7436
   🔍 [2/6] 分析訂單簿深度... ✅ Bids/Asks = 20/20 檔
   🔍 [3/6] 計算 Signed Volume (買賣壓力)... ✅ SV = -0.11
   � [4/6] 計算 VPIN (毒性指標)... ✅ VPIN = 0.300
   🔍 [5/6] 計算 Spread & Depth (流動性)... ✅ Spread = 0.01 bps, Depth = 17.50 BTC
   🔍 [6/6] 生成交易決策 (分層引擎)... ✅ 信號 = NEUTRAL

────────────────────────────────────────────────────────────────────────────────
📊 決策結果
────────────────────────────────────────────────────────────────────────────────
💰 當前價格: $104,808.85
📊 持倉狀態: 🏦 空倉

🎯 交易信號:
   方向: ⚖️ NEUTRAL
   信心度: 0.298
   風險等級: 🟢 SAFE

� 市場指標:
   🔴 OBI (訂單簿失衡): -0.7436 (極度失衡)
   ➡️ OBI Velocity (變化率): +0.0000 (穩定)
   💤 Signed Volume (淨量): -0.11 (平靜)
   � VPIN (毒性): 0.300 (安全)
   🟢 Spread (價差): 0.01 bps (流動性好)
   🟢 Depth (深度): 17.50 BTC (深度充足)

🤖 模型決策:
────────────────────────────────────────────────────────────────────────────────
   ❌🤖: 強制下單 | 📉 SHORT (強制)                                | 🏦 空倉
   🟡🤖: ⚖️  NEUTRAL (中立觀望)                                 | 🏦 空倉
   🔵🤖: ⚖️  NEUTRAL (中立觀望)                                 | 🏦 空倉
   🟢🤖: ⚖️  NEUTRAL (中立觀望)                                 | 🏦 空倉
────────────────────────────────────────────────────────────────────────────────

  [❌ Mode 0] ⚠️  強制交易: NEUTRAL → SHORT (OBI=-0.7436)

================================================================================
✅ 開空單
================================================================================
   模式: ❌🤖 Mode 0
   進場價格: 104787.89 USDT
   進場 OBI: -0.7436
   倉位大小: 0.0006 BTC
   🐢 槓桿: 2x | 倉位比例: 30%
   � 倉位價值: $60.00 USDT
================================================================================
```

持倉監控（即時更新）：

```
⠋ 價格: $104,808.85 | M0:📉 -0.04%

[15:40:28] 📊 持倉狀態: ❌🤖 Mode 0: � SHORT @ $104,787.89 (2x槓桿) | 🔴 未實現: -0.04% | ⏱️ 持倉: 0秒
```

測試結束摘要：

```
⏰ 測試結束，強制平倉...

📊 紙面交易統計摘要
================================================================================

【mode_0_no_risk】
  總訂單數: 8
  已阻擋: 0 (0.0%)
  已平倉: 8
  勝率: 62.5%
  平均 ROI: +0.35%

💾 訂單簿已保存: data/paper_trading_20251111_154027.json
📄 可讀 Log 已保存: data/paper_trading_20251111_154027.log
```

### 2. 分析訂單簿

```bash
# 分析最新訂單簿
python scripts/analyze_paper_trading.py

# 分析指定訂單簿
python scripts/analyze_paper_trading.py data/paper_trading_20251111_142800.json
```

**輸出示例：**
```
================================================================================
📊 紙面交易訂單簿分析
================================================================================
📁 檔案: data/paper_trading_20251111_142800.json
⏰ 時間: 20251111_142800
💰 初始資金: 100.0 USDT
📝 總決策數: 20
================================================================================

📈 各風控模式績效對比
================================================================================

❌ Mode 0: 無風控
  總訂單: 12
  已阻擋: 0 (0.0%)
  已平倉: 12
  勝率: 58.3% (7勝/5敗)
  總 ROI: +3.45%
  平均 ROI: +0.29%
  最佳/最差: +2.80% / -1.50%
  夏普比率: 0.45
  最大回撤: 2.10%
  平均持倉: 180 秒 (3.0 分鐘)
  盈虧比: 2.30

🟢 Mode 3: 完整風控
  總訂單: 12
  已阻擋: 3 (25.0%)
  已平倉: 9
  勝率: 77.8% (7勝/2敗)
  總 ROI: +5.80%
  平均 ROI: +0.64%
  最佳/最差: +2.80% / -0.50%
  夏普比率: 1.23
  最大回撤: 0.50%
  平均持倉: 165 秒 (2.8 分鐘)
  盈虧比: 11.60
  阻擋原因:
    • VPIN 過高 (0.752 > 0.7): 2 次
    • Spread 過寬 (12.30 bps): 1 次

🔍 風控有效性驗證
================================================================================
ROI 改善: +2.35% (+68.1%)
勝率改善: +19.5%
夏普比率改善: +0.78
最大回撤改善: +1.60%
交易機會成本: 25.0% (3 筆被阻擋)

✅ 結論: 風控指標**有效**，建議使用完整風控模式進行真實交易

🎯 風控阻擋有效性分析
================================================================================
🟢 Mode 3: 完整風控
  總阻擋: 3 筆
  對應虧損: 3 筆
  對應獲利: 0 筆
  阻擋準確率: 100.0%
  有效性: 有效

💾 分析報告已保存: data/paper_trading_20251111_142800_analysis.json
```

---

## 🎯 四種風控模式對比

| 模式 | 說明 | 風控規則 | 適用場景 |
|------|------|----------|----------|
| **Mode 0** | 無風控 | 無，所有信號都交易 | 基準對比，驗證風控價值 |
| **Mode 1** | 僅 VPIN | VPIN > 0.7 阻擋 | 閃崩防護（Flash Crash） |
| **Mode 2** | 僅流動性 | Spread > 10 bps 或 Depth < 3 BTC 阻擋 | 流動性不足防護 |
| **Mode 3** | 完整風控 | 所有風控規則 | **推薦真實交易使用** |

### 風控閾值說明

| 指標 | 閾值 | 含義 | 阻擋原因 |
|------|------|------|----------|
| **VPIN** | > 0.7 | 市場毒性過高 | 大型玩家單向交易，閃崩風險 |
| **Spread** | > 10 bps | 買賣價差過寬 | 流動性不足，執行成本高 |
| **Depth** | < 3 BTC | 訂單簿深度不足 | 大單會造成滑點 |

---

## 📊 訂單簿數據結構

### JSON 格式

```json
{
  "metadata": {
    "timestamp": "20251111_142800",
    "initial_capital": 100.0,
    "decision_interval": 15,
    "total_decisions": 20,
    "modes": ["mode_0_no_risk", "mode_1_vpin_only", ...]
  },
  "orders": {
    "mode_0_no_risk": [
      {
        "order_id": 0,
        "mode": "mode_0_no_risk",
        "timestamp": 1731312195000,
        "entry_time": "2025-11-11T14:23:15",
        
        // 市場數據
        "entry_price": 106500.00,
        "actual_entry_price": 106521.30,  // 含滑點
        "market_data": {
          "obi": 0.45,
          "signed_volume": 0.23,
          "vpin": 0.35,
          "spread_bps": 5.2,
          "total_depth": 8.5
        },
        
        // 決策信息
        "direction": "LONG",
        "confidence": 0.682,
        "risk_level": "SAFE",
        "signal": {...},
        
        // 倉位信息
        "capital": 100.0,
        "leverage": 3,
        "size": 0.5,  // 50%
        "position_value": 150.0,
        "stop_loss_pct": 5.0,
        "take_profit_pct": 8.0,
        
        // 平倉信息
        "exit_price": 106680.00,
        "exit_time": "2025-11-11T14:25:30",
        "exit_reason": "TAKE_PROFIT",
        "holding_seconds": 135.0,
        
        // 費用
        "entry_fee": 0.075,   // Taker Fee
        "exit_fee": 0.075,    // Taker Fee
        "funding_fee": 0.001, // Funding Rate
        
        // 盈虧
        "pnl_usdt": 3.38,
        "pnl_pct": 2.25,
        "roi": 3.38,  // 相對於初始資金
        
        // 狀態
        "status": "CLOSED",
        "can_trade": true,
        "blocked_reasons": []
      }
    ],
    "mode_3_full_risk": [
      {
        "order_id": 3,
        "status": "BLOCKED",
        "blocked_reasons": [
          "VPIN 過高 (0.752 > 0.7)",
          "Spread 過寬 (12.30 bps)"
        ]
      }
    ]
  }
}
```

---

## 💡 使用建議

### 1. 測試時長選擇

- **5 分鐘**：快速驗證系統運作
- **30 分鐘**：獲得初步統計顯著性
- **2 小時**：建議最小測試時長（足夠樣本數）
- **24 小時**：覆蓋完整交易週期（包含亞洲、歐洲、美洲時段）

### 2. 結果解讀

#### ✅ 風控有效的標誌

```
ROI 改善: +2.35% (+68.1%)          👈 Mode 3 比 Mode 0 好
勝率改善: +19.5%                   👈 阻擋了虧損交易
夏普比率改善: +0.78                👈 風險調整後收益更好
阻擋準確率: 100.0%                 👈 被阻擋的訂單都是虧損
```

#### ❌ 風控過度嚴格的標誌

```
交易機會成本: 80.0% (20 筆被阻擋)  👈 阻擋太多
Mode 3 總 ROI: +1.2%
Mode 0 總 ROI: +5.8%               👈 無風控反而更好
阻擋準確率: 40.0%                  👈 誤殺了獲利機會
```

**解決方案：調整閾值**
- 降低 VPIN 閾值：`0.7 → 0.8`
- 放寬 Spread 閾值：`10 bps → 15 bps`
- 降低 Depth 閾值：`3 BTC → 2 BTC`

### 3. 真實交易前的檢查清單

- [ ] 紙面交易運行 **至少 2 小時**
- [ ] Mode 3 (完整風控) 總 ROI > 0
- [ ] Mode 3 勝率 > 55%
- [ ] Mode 3 夏普比率 > 1.0
- [ ] 阻擋準確率 > 60%
- [ ] 最大回撤 < 10%
- [ ] 理解所有阻擋原因，無異常

---

## 🔧 進階配置

### 修改風控閾值

編輯 `scripts/paper_trading_system.py`：

```python
def apply_risk_control(self, decision: dict, mode: str) -> Tuple[bool, List[str]]:
    """應用風控規則"""
    market_data = decision.get('market_data', {})
    vpin = market_data.get('vpin', 0.3)
    spread_bps = market_data.get('spread_bps', 0)
    total_depth = market_data.get('total_depth', 0)
    
    blocked_reasons = []
    
    if mode == 'mode_3_full_risk':
        # 調整閾值
        if vpin > 0.8:  # 原本 0.7 → 0.8
            blocked_reasons.append(f"VPIN 過高 ({vpin:.3f} > 0.8)")
        if spread_bps > 15:  # 原本 10 → 15
            blocked_reasons.append(f"Spread 過寬 ({spread_bps:.2f} bps)")
        if total_depth < 2:  # 原本 3 → 2
            blocked_reasons.append(f"Depth 不足 ({total_depth:.2f} BTC)")
```

### 修改決策頻率

```python
system = PaperTradingSystem(
    initial_capital=100.0,
    decision_interval=10  # 原本 15 秒 → 10 秒
)
```

### 修改槓桿策略

```python
def _determine_leverage(self) -> int:
    """根據風險等級決定槓桿"""
    risk = self.market_data.get('risk_level', 'UNKNOWN')
    
    if risk == 'SAFE':
        return 10  # 原本 5 → 10（更激進）
    elif risk == 'WARNING':
        return 3   # 原本 2 → 3
    else:
        return 1
```

---

## 📁 輸出檔案

### 1. 訂單簿 JSON
- **位置**：`data/paper_trading_YYYYMMDD_HHMMSS.json`
- **內容**：完整訂單記錄（所有決策、指標、盈虧）
- **大小**：約 100-500 KB（5-30 分鐘）

### 2. 分析報告 JSON
- **位置**：`data/paper_trading_YYYYMMDD_HHMMSS_analysis.json`
- **內容**：績效統計、風控驗證、阻擋有效性
- **大小**：約 10-50 KB

---

## ⚠️ 注意事項

1. **網路連線**：需要穩定的網路連線至 Binance WebSocket
2. **測試時段**：避開重大新聞發布（非農、FOMC）
3. **費用計算**：已包含 Taker Fee (0.05%) + Funding Rate + Slippage
4. **資金管理**：初始資金固定 100 USDT，每筆交易獨立計算 ROI
5. **不保證獲利**：紙面交易僅供驗證，實際交易可能不同

---

## 🆘 常見問題

### Q1: 為什麼所有模式都沒有交易？

**可能原因：**
- 市場無明確信號（OBI、Signed Volume 都接近 0）
- 信心度不足（< 0.5）

**解決方案：**
- 延長測試時間（至少 30 分鐘）
- 檢查市場是否處於震盪盤整

### Q2: Mode 0 和 Mode 3 ROI 一樣？

**可能原因：**
- 測試期間市場狀態良好，無高風險時段
- 風控規則沒有觸發

**解決方案：**
- 延長測試至 2-4 小時（覆蓋更多市場狀態）
- 在波動較大的時段測試（美股開盤時段）

### Q3: 如何提高勝率？

**調整方向：**
1. **提高信心度閾值**：只交易信心度 > 0.7 的信號
2. **縮小止損範圍**：5% → 3%（但會增加止損頻率）
3. **延長持倉時間**：調整 `decision_interval` 從 15 秒 → 30 秒

### Q4: 阻擋準確率低於 50%？

**問題分析：**
- 風控規則過於保守，誤殺獲利機會

**解決方案：**
1. 放寬閾值（見「進階配置」）
2. 移除某些風控（例如只用 VPIN，不用 Spread/Depth）
3. 重新回測驗證

---

## 📚 相關文檔

- [VPIN_ADVANTAGE.md](../docs/VPIN_ADVANTAGE.md) - VPIN 指標說明
- [OBI_ADVANTAGE.md](../docs/OBI_ADVANTAGE.md) - OBI 指標說明
- [SIGNED_VOLUME_ADVANTAGE.md](../docs/SIGNED_VOLUME_ADVANTAGE.md) - Signed Volume 說明
- [SPREAD_DEPTH_ADVANTAGE.md](../docs/SPREAD_DEPTH_ADVANTAGE.md) - Spread & Depth 說明

---

## 🎓 總結

紙面交易系統是**真實交易前的最後一道防線**：

1. ✅ 使用真實市場數據（非歷史回測）
2. ✅ 真實費用計算（手續費、資金費率、滑點）
3. ✅ 多風控模式對比（證明風控價值）
4. ✅ 完整訂單簿記錄（事後分析）

**只有當紙面交易結果證明風控有效，才應該進行真實交易。**

---

**重要性：⭐⭐⭐⭐⭐**  
**用途：驗證風控指標是否真的有用**  
**目標：安全進入真實交易**
