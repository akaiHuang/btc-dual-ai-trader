# 📝 紙面交易系統 - 快速執行指南

## 🚀 執行方式

```bash
# 1. 進入專案目錄
cd /Users/akaihuangm1/Desktop/btn

# 2. 執行紙面交易系統 (直接使用虛擬環境 Python)
.venv/bin/python scripts/paper_trading_system.py [分鐘數]

# 範例:
.venv/bin/python scripts/paper_trading_system.py 1   # 測試 1 分鐘
.venv/bin/python scripts/paper_trading_system.py 5   # 測試 5 分鐘 (預設)
.venv/bin/python scripts/paper_trading_system.py 30  # 測試 30 分鐘
```

## 💡 為什麼使用 `.venv/bin/python`？

- ✅ **直接使用虛擬環境**：不受系統 Python alias 干擾
- ✅ **確保套件正確**：自動使用虛擬環境的依賴
- ✅ **跨終端一致**：無論 bash/zsh 都能正常執行

## 📊 執行後會顯示什麼？

### 1. 初始化階段
```
================================================================================
📝 Task 1.6.1 - Phase C: 紙面交易系統 (Paper Trading System)
================================================================================

────────────────────────────────────────────────────────────────────────────────
📖 市場指標說明
────────────────────────────────────────────────────────────────────────────────
📊 OBI (Order Book Imbalance)     訂單簿失衡度 [-1, 1]
   • 正值 = 買盤強勢 | 負值 = 賣盤強勢 | 0 = 平衡
   • 越接近 ±1 代表失衡越嚴重

⚡ OBI Velocity                    OBI 變化率 (速度)
   • 正值 = 買盤增強 | 負值 = 賣盤增強
   • 絕對值越大代表變化越快

📈 Signed Volume                   淨成交量 (買-賣)
   • 正值 = 主動買單多 | 負值 = 主動賣單多
   • 反映短期買賣壓力

☠️  VPIN (Volume-Synchronized PIN)  毒性指標 [0, 1]
   • 0 = 低風險 | 1 = 高風險
   • >0.5 表示知情交易者活躍，需謹慎

💹 Spread                          買賣價差 (bps)
   • 越小 = 流動性越好 | 越大 = 流動性差

🏊 Depth                           訂單簿深度 (BTC)
   • 前5檔買賣單總量，反映市場承接力
────────────────────────────────────────────────────────────────────────────────

────────────────────────────────────────────────────────────────────────────────
🎨 圖示說明
────────────────────────────────────────────────────────────────────────────────
交易方向:  📈 LONG (做多)  |  📉 SHORT (做空)  |  ⚖️  NEUTRAL (中立)
風險等級:  🟢 SAFE (安全)  |  🟡 WARNING (警告)  |  🔴 CRITICAL (嚴重)
持倉狀態:  🏦 空倉  |  📊 持倉中
開倉:      🚀 開倉  |  🔔 平倉
平倉原因:  🎯 TAKE_PROFIT (止盈)  |  🛑 STOP_LOSS (止損)  |  🔄 REVERSE_SIGNAL (反向)
────────────────────────────────────────────────────────────────────────────────

🎯 風控模式對比:
   Mode 0: ❌ 無風控（所有信號都交易）
   Mode 1: 🟡 僅 VPIN 風控
   Mode 2: 🔵 僅流動性風控（Spread/Depth）
   Mode 3: 🟢 完整風控（所有指標）

⏱️  測試配置:
   💹 交易對: BTCUSDT
   ⚡ 決策模式: 動態觸發 (最快5秒 / 最慢15秒)
   🎯 觸發條件:
      • 強烈信號: |OBI| > 0.6
      • 快速變化: |ΔOBI| > 0.3
      • 方向反轉: OBI跨越0軸

💰 資金配置:
   💵 初始本金: 100.0 USDT
   📊 最大槓桿: 10x
   📐 倉位策略: 🐢 保守 30% | 🚶 中等 50% | 🏃 激進 80%

💸 費率設定:
   ✅ Maker 手續費: 0.02%
   💳 Taker 手續費: 0.05%
   💰 資金費率: 0.003%/小時

🎯 風控設定:
   🟢 安全模式: 槓桿 5x | 止損 5% | 止盈 8%
   🟡 警告模式: 槓桿 2x | 止損 8% | 止盈 12%
   🔴 危險模式: 槓桿 1x | 止損 10% | 止盈 15%

================================================================================

⏰ 運行時長: 1 分鐘

🔌 連接 Binance WebSocket...
✅ WebSocket 已連接

📥 初始化訂單簿數據...
   ✅ 訂單簿已初始化
   最佳買價: 104,808.80
   最佳賣價: 104,808.90
   當前價格: $104,808.85
   買單量 (20檔): 2.2860 BTC
   賣單量 (20檔): 15.6360 BTC
   初始 OBI: -0.7449

🔥 開始紙面交易...
```

### 2. 決策分析過程
```
================================================================================
[15:40:27] 🧠 定期決策分析 #1
================================================================================
   🔍 [1/6] 計算 OBI (訂單簿失衡)... ✅ OBI = -0.7436
   🔍 [2/6] 分析訂單簿深度... ✅ Bids/Asks = 20/20 檔
   🔍 [3/6] 計算 Signed Volume (買賣壓力)... ✅ SV = -0.11
   🔍 [4/6] 計算 VPIN (毒性指標)... ✅ VPIN = 0.300
   🔍 [5/6] 計算 Spread & Depth (流動性)... ✅ Spread = 0.01 bps, Depth = 17.50 BTC
   🔍 [6/6] 生成交易決策 (分層引擎)... ✅ 信號 = NEUTRAL

────────────────────────────────────────────────────────────────────────────────
📊 決策結果
────────────────────────────────────────────────────────────────────────────────
💰 當前價格: $104,808.85
📊 持倉狀態: 🏦 空倉

🎯 交易信號:
   方向: ⚖️ NEUTRAL
   信心度: 0.298
   風險等級: 🟢 SAFE

📈 市場指標:
   🔴 OBI (訂單簿失衡): -0.7436 (極度失衡)
   ➡️ OBI Velocity (變化率): +0.0000 (穩定)
   📈 Signed Volume (淨量): -0.11 (平靜)
   🟢 VPIN (毒性): 0.300 (安全)
   🟢 Spread (價差): 0.01 bps (流動性好)
   🟢 Depth (深度): 17.50 BTC (深度充足)

🤖 模型決策:
────────────────────────────────────────────────────────────────────────────────
   ❌🤖: 強制下單 | 📉 SHORT (強制)                                | 🏦 空倉
   🟡🤖: ⚖️  NEUTRAL (中立觀望)                                 | 🏦 空倉
   🔵🤖: ⚖️  NEUTRAL (中立觀望)                                 | 🏦 空倉
   🟢🤖: ⚖️  NEUTRAL (中立觀望)                                 | 🏦 空倉
────────────────────────────────────────────────────────────────────────────────


📋 即時交易記錄:
────────────────────────────────────────────────────────────────────────────────
15:40:27 | -0.7436 | NEUTRAL      | ❌🤖 Mode 0 | 🏦 空倉       | 觀望
15:40:27 | -0.7436 | NEUTRAL      | 🟡🤖 Mode 1 | 🏦 空倉       | 觀望
15:40:27 | -0.7436 | NEUTRAL      | 🔵🤖 Mode 2 | 🏦 空倉       | 觀望
15:40:27 | -0.7436 | NEUTRAL      | 🟢🤖 Mode 3 | 🏦 空倉       | 觀望
────────────────────────────────────────────────────────────────────────────────
```

### 3. 開倉通知
```
  [❌ Mode 0] ⚠️  強制交易: NEUTRAL → SHORT (OBI=-0.7436)

================================================================================
✅ 開空單
================================================================================
   模式: ❌🤖 Mode 0
   進場價格: 104787.89 USDT
   進場 OBI: -0.7436
   倉位大小: 0.0006 BTC
   🐢 槓桿: 2x | 倉位比例: 30%
   📊 倉位價值: $60.00 USDT
================================================================================
```

### 4. 即時持倉監控
```
⠋ 價格: $104,808.85 | M0:📉 -0.04%

[15:40:28] 📊 持倉狀態: ❌🤖 Mode 0: 📉 SHORT @ $104,787.89 (2x槓桿) | 🔴 未實現: -0.04% | ⏱️ 持倉: 0秒
```

### 5. 持續監控與下一次決策
```
⠋ 價格: $104,804.35 | M0:📉 -0.03%

[15:40:33] 📊 持倉狀態: ❌🤖 Mode 0: 📉 SHORT @ $104,787.89 (2x槓桿) | 🔴 未實現: -0.03% | ⏱️ 持倉: 5秒

================================================================================
[15:40:43] 🧠 定期決策分析 #2
================================================================================
   🔍 [1/6] 計算 OBI (訂單簿失衡)... ✅ OBI = -0.7246
   🔍 [2/6] 分析訂單簿深度... ✅ Bids/Asks = 20/20 檔
   🔍 [3/6] 計算 Signed Volume (買賣壓力)... ✅ SV = -8.67
   🔍 [4/6] 計算 VPIN (毒性指標)... ✅ VPIN = 0.877
   🔍 [5/6] 計算 Spread & Depth (流動性)... ✅ Spread = 0.01 bps, Depth = 7.70 BTC
   🔍 [6/6] 生成交易決策 (分層引擎)... ✅ 信號 = NEUTRAL

────────────────────────────────────────────────────────────────────────────────
📊 決策結果
────────────────────────────────────────────────────────────────────────────────
💰 當前價格: $104,767.85
📊 持倉狀態:
   ❌🤖 Mode 0: 📉 SHORT @ $104,787.89 | 🟢 未實現: +0.04%

🎯 交易信號:
   方向: ⚖️ NEUTRAL
   信心度: 0.316
   風險等級: 🟡 WARNING

📈 市場指標:
   🔴 OBI (訂單簿失衡): -0.7246 (極度失衡)
   ➡️ OBI Velocity (變化率): +0.0190 (穩定)
   💥 Signed Volume (淨量): -8.67 (強力賣壓)
   ☠️ VPIN (毒性): 0.877 (高毒性)
   🟢 Spread (價差): 0.01 bps (流動性好)
   🟢 Depth (深度): 7.70 BTC (深度充足)
```
```
================================================================================
平倉: SHORT
================================================================================
   模式: ❌🤖 Mode 0
   出場價格: 90985.30 USDT
   出場 OBI: +0.3250
   持有時間: 135.2 秒
   🟢 本次 PnL: +0.83% (+0.83 USDT)
   累計 PnL: +0.83 USDT
   🔄 平倉原因: REVERSE_SIGNAL
================================================================================
### 6. 平倉通知
```
================================================================================
平倉: SHORT
================================================================================
   模式: ❌🤖 Mode 0
   出場價格: 104625.30 USDT
   出場 OBI: +0.3250
   持有時間: 45.2 秒
   🟢 本次 PnL: +0.31% (+0.31 USDT)
   累計 PnL: +0.31 USDT
   🔄 平倉原因: REVERSE_SIGNAL
================================================================================
```

### 7. 測試結束摘要
```
📊 紙面交易統計摘要
================================================================================

【mode_0_no_risk】
  總訂單數: 8
  已阻擋: 0 (0.0%)
  已平倉: 8
  勝率: 62.5%
  平均 ROI: +0.35%
  最佳 ROI: +2.80%
  最差 ROI: -1.20%

【mode_3_full_risk】
  總訂單數: 8
  已阻擋: 2 (25.0%)
  已平倉: 6
  勝率: 83.3%
  平均 ROI: +0.58%
  最佳 ROI: +2.80%
  最差 ROI: -0.40%

💾 訂單簿已保存: data/paper_trading_20251111_142530.json
📄 可讀 Log 已保存: data/paper_trading_20251111_142530.log
```

## 📊 數據分析

### 執行分析腳本
```bash
# 分析最新訂單簿
.venv/bin/python scripts/analyze_paper_trading.py

# 分析指定訂單簿
.venv/bin/python scripts/analyze_paper_trading.py data/paper_trading_20251111_142530.json
```

### 分析報告內容
```
================================================================================
📊 紙面交易訂單簿分析
================================================================================
📁 檔案: data/paper_trading_20251111_142530.json
⏰ 時間: 20251111_142530
💰 初始資金: 100.0 USDT
📝 總決策數: 20

📈 各風控模式績效對比
================================================================================

❌ Mode 0: 無風控
  總訂單: 12
  已阻擋: 0 (0.0%)
  已平倉: 12
  勝率: 58.3% (7勝/5敗)
  總 ROI: +3.45%
  平均 ROI: +0.29%
  夏普比率: 0.45
  最大回撤: 2.10%
  平均持倉: 180 秒 (3.0 分鐘)
  盈虧比: 2.30

🟢 Mode 3: 完整風控
  總訂單: 12
  已阻擋: 3 (25.0%)
  已平倉: 9
  勝率: 77.8% (7勝/2敗)
  總 ROI: +5.80%
  平均 ROI: +0.64%
  夏普比率: 1.23
  最大回撤: 0.50%
  平均持倉: 165 秒 (2.8 分鐘)
  盈虧比: 11.60
  阻擋原因:
    • VPIN 過高 (0.752 > 0.7): 2 次
    • Spread 過寬 (12.30 bps): 1 次

🔍 風控有效性驗證
================================================================================
ROI 改善: +2.35% (+68.1%)
勝率改善: +19.5%
夏普比率改善: +0.78
最大回撤改善: +1.60%
交易機會成本: 25.0% (3 筆被阻擋)

✅ 結論: 風控指標**有效**，建議使用完整風控模式進行真實交易
```

## 🔍 如何解讀這些數據？

### 1. 市場指標 (實時更新)

| 指標 | emoji | 含義 | 交易決策影響 |
|------|-------|------|--------------|
| **OBI (訂單簿失衡)** | 🔴🟡🟢 | 買賣盤力量對比 | 🔴 極度失衡時考慮順勢 |
| **OBI Velocity** | ⚡➡️ | OBI 變化速度 | ⚡ 快速變化時動態觸發 |
| **Signed Volume** | 💥🔥💤 | 主動買賣壓力 | 💥 強力壓力確認方向 |
| **VPIN (毒性)** | ☠️⚠️🟡🟢 | 知情交易者活躍度 | ☠️ 高毒性阻擋交易 (閃崩風險) |
| **Spread (價差)** | 🔴🟡🟢 | 流動性好壞 | 🔴 價差過寬阻擋 (成本高) |
| **Depth (深度)** | 🔴🟡🟢 | 訂單簿承接力 | 🔴 深度不足阻擋 (滑點大) |

### 2. 模型決策 (4 種模式同時運行)

| 模式 | emoji | 策略 | 用途 |
|------|-------|------|------|
| **Mode 0** | ❌🤖 | 無風控，強制交易所有信號 | 基準對照組 |
| **Mode 1** | 🟡🤖 | 僅 VPIN 風控 (閃崩防護) | 測試毒性指標價值 |
| **Mode 2** | 🔵🤖 | 僅流動性風控 (Spread/Depth) | 測試流動性指標價值 |
| **Mode 3** | 🟢🤖 | 完整風控 (所有指標) | **推薦真實交易使用** |

### 3. 績效指標解讀

#### ✅ 風控有效的標誌
- **ROI 改善 > 0**：Mode 3 比 Mode 0 賺更多
- **勝率改善 > 0**：成功阻擋虧損交易
- **夏普比率 > 1.0**：風險調整後收益優秀
- **阻擋準確率 > 60%**：被阻擋的訂單大多是虧損

**範例（好的結果）：**
```
ROI 改善: +2.35% (+68.1%)      👈 Mode 3 多賺 68%
勝率改善: +19.5%                👈 減少虧損交易
夏普比率: 1.23 (vs 0.45)       👈 風險調整後更優
阻擋準確率: 100.0%              👈 完美攔截虧損
```

#### ❌ 風控過度嚴格的標誌
- **交易機會成本 > 50%**：阻擋太多
- **Mode 0 ROI > Mode 3 ROI**：無風控反而更好
- **阻擋準確率 < 40%**：誤殺獲利機會

**範例（需調整）：**
```
交易機會成本: 80.0%             👈 阻擋太多
Mode 0 總 ROI: +5.8%
Mode 3 總 ROI: +1.2%            👈 風控反而變差
阻擋準確率: 35.0%               👈 誤殺獲利
```

### 4. 動態觸發機制

系統不是每 15 秒固定決策，而是**事件驅動 + 定期檢查**：

#### 觸發條件
1. **強烈信號**：`|OBI| > 0.6` → 買賣盤極度失衡，立即決策
2. **快速變化**：`|ΔOBI| > 0.3` → 市場快速反轉，立即反應
3. **方向反轉**：OBI 跨越 0 軸 → 多空轉換，立即平倉
4. **定期檢查**：最多 15 秒 → 避免錯過機會

**範例輸出：**
```
⚡ 動態觸發決策 #3 - 強烈信號 OBI=-0.6543
⚡ 動態觸發決策 #5 - 快速變化 Δ=+0.4120
⚡ 動態觸發決策 #7 - 方向反轉 -0.35→+0.28
🧠 定期決策分析 #10
```

## 📁 輸出檔案

### 1. JSON 訂單簿 (機器可讀)
- **路徑**：`data/paper_trading_YYYYMMDD_HHMMSS.json`
- **用途**：分析腳本輸入、績效回測
- **內容**：完整市場數據、決策記錄、盈虧計算

### 2. TXT Log (人類可讀)
- **路徑**：`data/paper_trading_YYYYMMDD_HHMMSS.log`
- **用途**：快速查看交易記錄
- **內容**：每筆訂單詳細信息、統計摘要

### 3. 分析報告 (JSON)
- **路徑**：`data/paper_trading_YYYYMMDD_HHMMSS_analysis.json`
- **用途**：績效對比、風控驗證
- **內容**：勝率、ROI、夏普比率、阻擋有效性

## 🎯 實戰建議

### 測試時長選擇
- **1-5 分鐘**：快速驗證系統運作 ✅
- **30 分鐘**：獲得初步統計顯著性
- **2 小時**：建議最小測試時長（足夠樣本數）
- **24 小時**：覆蓋完整交易週期（包含亞洲、歐洲、美洲時段）

### 真實交易前檢查清單
- [ ] 紙面交易運行至少 2 小時
- [ ] Mode 3 (完整風控) 總 ROI > 0
- [ ] Mode 3 勝率 > 55%
- [ ] Mode 3 夏普比率 > 1.0
- [ ] 阻擋準確率 > 60%
- [ ] 最大回撤 < 10%
- [ ] 理解所有阻擋原因，無異常

### 風控調整 (進階)
如果發現風控過於嚴格，可以調整閾值：

編輯 `scripts/paper_trading_system.py`：
```python
# Line 800-850: 風控規則
if mode == 'mode_3_full_risk':
    if vpin > 0.8:  # 原本 0.7 → 0.8 (放寬)
        blocked_reasons.append(...)
    if spread_bps > 15:  # 原本 10 → 15 (放寬)
        blocked_reasons.append(...)
    if total_depth < 2:  # 原本 3 → 2 (放寬)
        blocked_reasons.append(...)
```

## 🆘 常見問題

### Q1: 為什麼所有模式都沒交易？
**可能原因**：市場無明確信號（OBI 接近 0，信心度低）  
**解決方案**：延長測試時間至 30 分鐘，或在美股開盤時段測試

### Q2: Mode 0 和 Mode 3 結果一樣？
**可能原因**：測試期間市場狀態良好，無高風險時段  
**解決方案**：延長至 2-4 小時，覆蓋更多市場狀態

### Q3: 如何提高勝率？
**調整方向**：
1. 提高信心度閾值（只交易 > 0.7 的信號）
2. 縮小止損範圍（5% → 3%）
3. 延長持倉時間（調整決策間隔）

### Q4: WebSocket 連線失敗？
**可能原因**：網路不穩定或 Binance 限流  
**解決方案**：
```bash
# 檢查網路
ping fstream.binance.com

# 如果是 VPN 問題，嘗試關閉 VPN
# 如果是限流，等待 1 分鐘後重試
```

## 📚 延伸閱讀

- [紙面交易系統完整文檔](docs/PAPER_TRADING_GUIDE.md)
- [VPIN 指標說明](docs/VPIN_ADVANTAGE.md)
- [OBI 指標說明](docs/OBI_ADVANTAGE.md)
- [HFT 策略分析](docs/HFT_STRATEGY_ANALYSIS.md)

## 🎓 總結

紙面交易系統是**真實交易前的最後一道防線**：

1. ✅ 使用真實市場數據（Binance WebSocket）
2. ✅ 真實費用計算（手續費、資金費率、滑點）
3. ✅ 多風控模式對比（證明風控價值）
4. ✅ 動態觸發機制（最快 5 秒反應）
5. ✅ 完整訂單簿記錄（事後分析）

**只有當紙面交易結果證明風控有效，才應該進行真實交易。**

---

**更新日期**：2025-11-11  
**版本**：v2.0 (新增動態觸發 + 市場指標 emoji + 模型決策可視化)
